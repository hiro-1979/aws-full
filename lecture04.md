# AWSフルコース第4回課題 2022/10/01

- VPC、EC2、RDSの作成はテキストの通りに順調に進めた為、  
  Cloud9からEC2への接続、EC2からRDSへの接続に行った手順を成果物として提出致します。
- 別途自分用に用語も整理中ですがまだまだ作成途中で、今後理解が深まったら都度更新します。

## 課題作成した構成

### EC2

| タグ(Name) | VPCID | セキュリティグループ |
| --- | --- | --- |
| raisetech-ec2 | vpc-0************* | sg-0*************** (launch-wizard-1) |

- ※提出用は*で伏字にさせて頂きます。

### RDS

| DBクラスター識別子 | VPCID | セキュリティグループ |
| --- | --- | --- |
| database-1 | vpc-0*************** | default (sg-0***************) |

|  エンドポイント |
|  --- |
| database-1.***************.ap-northeast-1.rds.amazonaws.com |

- ※提出用は*で伏字にさせて頂きます。

---

## Cloud9からEC2へのログイン

1. EC2インスタンスのパブリックIPをコピーする。

    - インスタンス一覧からインスタンスIDをクリック
    - インスタンスの概要からパブリックIPアドレスを確認
    - ※パブリックIPアドレスはインスタンスを再起動するとその都度変わるので注意！

    ![パブリックIP](image/パブリックIP.png)

2. SSHコマンドでログイン試行する

    ```sh
    ssh -i ＜pemキーのパス＞ ec2-user@＜パブリックIP＞
    ```

    ※実行例

    ```sh
    ssh -i raisetech-sample.pem ec2-user@123.456.789.123
    ```

3. Permission deniedのエラー発生

    - 下図のエラーが発生する。

    ![パーミッションエラー](image/EC2%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC.png)

4. pemキーを~/.sshに移動し、パーミッションを700に変更

    ```sh
    mv /home/ec2-user/environment/raisetech-ec2.pem /home/ec2-user/.ssh
    chmod 700 raisetech-ec2.pem 
    ```

5. 再度SSHコマンドでログイン試行すると、ログイン成功する。

    ![ログイン成功](image/%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%88%90%E5%8A%9F.png)

---

## EC2からRDSへのログイン

1. EC2からmysqlコマンドでRDSに接続する為、EC2側にmysqlをインストールする

    ```sh
    sudo yum install mysql
    ```

    - clientだけインストールで良いのではと思ったが今回は上記でインストールした<https://qiita.com/tamorieeeen/items/d9b2af588f1dfd43120d>

2. RDSのエンドポイントをコピーする

    ![RDSエンドポイント](image/RDS%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88.png)

    - データベース一覧からデータベース識別子をクリック
    - 接続とセキュリティのエンドポイントを確認

3. 下記コマンドでRDSのMySQLにログインを試行する。

    ```sh
    mysql -u admin -p -h ＜RDSのエンドポイント＞
    ```

    ※実行例

    ```sh
    mysql -u admin -p -h database-1.***************.ap-northeast-1.rds.amazonaws.com -P 3306
    ```

4. MySQL接続エラー発生
    - 下図のエラーが発生する。

    ![MySQL接続エラー](image/mysql%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC.png)

5. RDSのデータベース一覧からDB識別子をクリック
6. 接続とセキュリティのVPC セキュリティグループをクリック

    ![RDSセキュリティグループ](image/RDS%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97.png)

7. インバウンドルールタブをクリック
8. 「インバウンドのルールを編集」ボタンをクリック
9. 「ルールを追加ボタン」をクリック
10. 以下の様にルールを追加する
    | タイプ | プロトコル | ポート | ソース |
    | --- | --- | --- | --- |
    | MySQL/Aurora | TCP(自動で入る) | 3306(自動で入る) | Ec2のセキュリティグループ |

    ![RDSエンドポイント](image/%E3%82%A4%E3%83%B3%E3%83%90%E3%82%A6%E3%83%B3%E3%83%89%E3%83%AB%E3%83%BC%E3%83%AB.png)

11. 再度のMySQLにログインを試行すると成功する。

    ![MySQLログイン成功](image/MySQL%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%88%90%E5%8A%9F.png)

## 追記(EC2からRDS接続について)

- 後から分かった事ですが、RDS作成時にコンピューティングリソースの設定で「EC2コンピューティングリソースに接続」を選択すると、EC2からRDSに接続できるセキュリティグループ設定をよろしくやってくれました。。。  
  従ってこちらの選択肢を選んだ場合は、インバンドルールの手動設定は不要です。
  
    ![EC2からのRDS接続許可オプション](image/RDS%E3%81%AEEC2%E6%8E%A5%E7%B6%9A%E8%A8%AD%E5%AE%9A.png)
